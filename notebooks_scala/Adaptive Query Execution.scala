{"version":"NotebookV1","origId":1965691013915016,"name":"Adaptive Query Execution","language":"scala","commands":[{"version":"CommandV1","origId":1965691013915017,"guid":"e0ed37cd-ff31-4e5e-8f2a-2c676fba168e","subtype":"command","commandType":"auto","position":0.875,"command":"%md\nhttps://databricks.com/de/blog/2020/05/29/adaptive-query-execution-speeding-up-spark-sql-at-runtime.html","commandVersion":2,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"1fbb5d18-ef52-44a3-a025-801a7d3834eb"},{"version":"CommandV1","origId":1965691013915018,"guid":"226ae890-2b5b-4ff9-aa3c-2609b2882e0c","subtype":"command","commandType":"auto","position":1.75,"command":"%md\nhttps://docs.databricks.com/_static/notebooks/aqe-demo.html?_ga=2.96665439.1135627284.1602308202-183110992.1602308202","commandVersion":3,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"0d103880-4f30-4d8c-bd53-2ab90f3f3237"},{"version":"CommandV1","origId":1965691013915019,"guid":"53be9a4d-3f72-4db5-ac39-566a204a3436","subtype":"command","commandType":"auto","position":3.5,"command":"%sql\nCREATE DATABASE IF NOT EXISTS aqe_demo_db;\nUSE aqe_demo_db;\n\nDROP TABLE IF EXISTS items;\nDROP TABLE IF EXISTS sales;\n\n-- Create \"items\" table.\n\nCREATE TABLE items\nUSING parquet\nAS\nSELECT id AS i_item_id,\nCAST(rand() * 1000 AS INT) AS i_price\nFROM RANGE(30000000);\n\n-- Create \"sales\" table with skew.\n-- Item with id 100 is in 80% of all sales.\n\nCREATE TABLE sales\nUSING parquet\nAS\nSELECT CASE WHEN rand() < 0.8 THEN 100 ELSE CAST(rand() * 30000000 AS INT) END AS s_item_id,\nCAST(rand() * 100 AS INT) AS s_quantity,\nDATE_ADD(current_date(), - CAST(rand() * 360 AS INT)) AS s_date\nFROM RANGE(1000000000);","commandVersion":4,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"wadson@insightahead.com","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"b768d281-0da1-4383-bf67-5a0ab68f3084"},{"version":"CommandV1","origId":1965691013915020,"guid":"56adcd2f-cb1a-49a3-842a-34dd6f04f713","subtype":"command","commandType":"auto","position":3.94921875,"command":"val salesDf = spark.read.table(\"aqe_demo_db.sales\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"wadson@insightahead.com","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"b383f39e-9daf-48fa-a96d-5b81d94c9c4e"},{"version":"CommandV1","origId":1965691013915021,"guid":"299f123b-ffe0-4f8f-af12-e62f2aa516bf","subtype":"command","commandType":"auto","position":4.20703125,"command":"val itemsDf = spark.read.table(\"aqe_demo_db.items\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"wadson@insightahead.com","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ac3d9902-2785-44cc-b197-400a1ef0e6c1"},{"version":"CommandV1","origId":1965691013915022,"guid":"04c6a26b-02e7-4dce-8933-8bafc4bcb910","subtype":"command","commandType":"auto","position":4.96484375,"command":"import org.apache.spark.sql.functions._","commandVersion":11,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"wadson@insightahead.com","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"1c4eed61-7417-4194-af10-766d31b657dc"},{"version":"CommandV1","origId":1965691013915023,"guid":"d19eeaa2-7485-4e51-badc-edff9c35549f","subtype":"command","commandType":"auto","position":9.90234375,"command":"%md\n# Enable Adaptive Query Execution (AQE)","commandVersion":21,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"702d8ea0-2422-4350-bc8b-86a6a60479ab"},{"version":"CommandV1","origId":1965691013915024,"guid":"d5bb0070-19a2-430c-ab35-fe262e02ed31","subtype":"command","commandType":"auto","position":11.99609375,"command":"spark.conf.get(\"spark.sql.adaptive.enabled\")","commandVersion":3,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"wadson@insightahead.com","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"eaff62b3-8eef-4790-8bf5-48a925430875"},{"version":"CommandV1","origId":1965691013915025,"guid":"4d215026-2361-41ca-bb69-4d5f290f7100","subtype":"command","commandType":"auto","position":13.04296875,"command":"spark.conf.set(\"spark.sql.adaptive.enabled\",\"true\")","commandVersion":40,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"wadson@insightahead.com","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"340cad65-1af2-49e5-9d03-7e176054c870"},{"version":"CommandV1","origId":1965691013915026,"guid":"77a2265c-ed14-417c-8a52-77358025ff32","subtype":"command","commandType":"auto","position":14.08984375,"command":"%md \n# Dynamically Coalesce Shuffle Partitions\n","commandVersion":6,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"3aada1a6-7176-41c0-b976-572d86cd59b6"},{"version":"CommandV1","origId":1965691013915027,"guid":"fb991c85-199f-461c-84fd-47d05cae8d59","subtype":"command","commandType":"auto","position":14.40234375,"command":"val coalescePartitionDf =\nsalesDf.groupBy(\"s_date\")\n.agg(sum(\"s_quantity\").as(\"q\"))\n.orderBy(desc(\"q\"))\n","commandVersion":12,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"wadson@insightahead.com","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"c141df31-fed1-450a-8c4a-4d109cedf953"},{"version":"CommandV1","origId":1965691013915028,"guid":"92ec0d81-135a-4b89-8755-f20ce4ede5e9","subtype":"command","commandType":"auto","position":14.51953125,"command":"coalescePartitionDf.show","commandVersion":4,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"wadson@insightahead.com","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"e257977c-71cb-4d9c-bf76-ef367b27a1b7"},{"version":"CommandV1","origId":1965691013915029,"guid":"5e8aa421-7bb9-44e9-b7d0-02b7d4cfea83","subtype":"command","commandType":"auto","position":14.578125,"command":"coalescePartitionDf.show","commandVersion":1,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"wadson@insightahead.com","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"7c4cb5e3-a444-4321-ab25-b3e7982c32b8"},{"version":"CommandV1","origId":1965691013915030,"guid":"0eb088e0-82e1-4362-996b-5ad4c4e28219","subtype":"command","commandType":"auto","position":14.63671875,"command":"%md\nhttps://spark.apache.org/docs/latest/sql-performance-tuning.html#coalescing-post-shuffle-partitions","commandVersion":3,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"1e9f7e97-d8e5-42f8-ad1f-fc52b98457d0"},{"version":"CommandV1","origId":1965691013915031,"guid":"a0ce04c7-ecb6-411d-bad8-ad529e56bea6","subtype":"command","commandType":"auto","position":14.71484375,"command":"%md\n# Dynamically Switch Join Strategies","commandVersion":3,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"d04bedfb-000e-4575-a9e8-f08f814bb83a"},{"version":"CommandV1","origId":1965691013915032,"guid":"60f3c8b4-750a-4587-9a0b-40d923a83f79","subtype":"command","commandType":"auto","position":14.83984375,"command":"// Get total sales amount grouped by sales date for items with a price lower than 10.\n// The selectivity of the filter by price is not known in static planning, so the initial plan opts for sort merge join.\n// But in fact, the \"items\" table after filtering is very small, so the query can do a broadcast hash join instead.\n// Static explain shows the initial plan with sort merge join.\n\nval switchJoinDf = \nsalesDf.join(itemsDf, 's_item_id === 'i_item_id)\n.where(\"i_price < 10\")\n.groupBy('s_date)\n.agg(sum('s_quantity * 'i_price).as(\"total_sales\"))\n.orderBy(desc(\"total_sales\"))","commandVersion":30,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"wadson@insightahead.com","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"c18c068d-a3b6-4298-9fa3-bee45784a5d6"},{"version":"CommandV1","origId":1965691013915033,"guid":"665a526c-5bee-4188-8180-7456c3077ca8","subtype":"command","commandType":"auto","position":14.96484375,"command":"%md\n# Dynamically Optimize Skew Join","commandVersion":7,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"09c0d304-7643-4e04-9a3b-5dd2bf95964a"},{"version":"CommandV1","origId":1965691013915034,"guid":"7eb12d60-3a8b-4e33-ae97-14deaab9beae","subtype":"command","commandType":"auto","position":15.21484375,"command":"// Get the total sales amount grouped by sales date.\n// The partition in the \"sales\" table containing value \"100\" as \"s_item_id\" is much larger than other partitions.\n// AQE splits the skewed partition into smaller partitions before joining the \"sales\" table with the \"items\" table.\n\nval skewJoinDf = \nsalesDf.join(itemsDf, 's_item_id === 'i_item_id)\n.groupBy('s_date)\n.agg(sum('s_quantity * 'i_price).as(\"total_sales\"))\n.orderBy(desc(\"total_sales\"))","commandVersion":17,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"wadson@insightahead.com","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"3b98cee6-1885-4f25-a6aa-309ceb702e4f"},{"version":"CommandV1","origId":1965691013915035,"guid":"c1217b49-84e0-4f44-aed9-0a12aa2e465e","subtype":"command","commandType":"auto","position":16.21484375,"command":"switchJoinDf.show","commandVersion":3,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"wadson@insightahead.com","latestUserId":"4218386567210383","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"5b96a3b8-0ed9-4644-96d0-69e86706938f"}],"dashboards":[],"guid":"c8e6e819-ec5b-4ffd-b012-7536eb843483","globalVars":{},"iPythonMetadata":null,"inputWidgets":{}}